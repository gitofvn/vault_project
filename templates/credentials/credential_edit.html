{% extends 'base.html' %}
{% block title %}{{ view.object.site_name|default:"Add Credential" }}{% endblock %}

{% block layout %}
<div class="dashboard-wrapper">
  {% include 'common/base_navigation.html' %}

  <main class="dashboard-main">
    <div class="form-container">
      <h2 class="form-title">{{ view.object.site_name|default:"Add Credential" }}</h2>
      <hr class="notes-separator">

      <form method="post" class="note-form">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="edit-grid">
          <!-- LEFT COLUMN -->
          <div class="col-left">

            <!-- Categories -->
            <div class="input-group">
              <label>Categories</label>

              <!-- Visible badges -->
              <div id="category-badges" class="credential-categories"></div>

              <!-- Add new category -->
              <input
                type="text"
                id="category-add-input"
                placeholder="Add category and press Enter"
                class="category-add-input"
                autocomplete="off"
              />
              <small class="hint">Remove a category with ×. Add a new one and press Enter.</small>

              <!-- Hidden original fields -->
              <div style="display:none;">
                {{ form.categories }}
                {{ form.categories_input }}
              </div>
            </div>

            <!-- Site Name -->
            <div class="input-group">
              {{ form.site_name.label_tag }}
              {{ form.site_name }}
              {{ form.site_name.errors }}
            </div>

            <!-- Username -->
            <div class="input-group">
              {{ form.username.label_tag }}
              {{ form.username }}
              {{ form.username.errors }}
            </div>

            <!-- Email -->
            <div class="input-group">
              {{ form.email.label_tag }}
              {{ form.email }}
              {{ form.email.errors }}
            </div>

            <!-- Password -->
            <div class="input-group">
              <label for="id_password">Password</label>
              {{ form.password }}
              {{ form.password.errors }}
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <div class="col-right">

            <!-- Phone Number -->
            <div class="input-group">
              {{ form.phone_number.label_tag }}
              {{ form.phone_number }}
              {{ form.phone_number.errors }}
            </div>

            <!-- Other -->
            <div class="input-group">
              {{ form.other.label_tag }}
              {{ form.other }}
              {{ form.other.errors }}
            </div>

            <!-- Site URL (optional: leave on right or move left if you prefer) -->
            <div class="input-group">
              {{ form.site_url.label_tag }}
              {{ form.site_url }}
              {{ form.site_url.errors }}
            </div>
          </div>
        </div>

        <hr class="notes-separator">

        <!-- Actions -->
        <div class="note-actions edit-actions">
          <button type="submit" class="note-btn">Save</button>
          <a href="{% url 'credential-list' %}" class="note-btn">Cancel</a>
        </div>
      </form>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const badgeWrap = document.getElementById('category-badges');
        const addInput  = document.getElementById('category-add-input');

        const selectEl  = document.getElementById('id_categories');        // hidden multiple select
        const newField  = document.getElementById('id_categories_input');  // hidden comma list

        if (!badgeWrap || !addInput || !selectEl || !newField) return;

        const newNames = new Set();

        function makeBadge({ id=null, name, isNew=false }) {
          const span = document.createElement('span');
          span.className = 'category-badge';
          span.dataset.catName = name;
          if (id) span.dataset.catId = String(id);
          if (isNew) span.dataset.new = '1';
          span.innerHTML = `${name} <button type="button" class="category-badge__remove" aria-label="Remove ${name}">×</button>`;
          return span;
        }

        function renderFromSelect() {
          badgeWrap.innerHTML = '';
          Array.from(selectEl.options).forEach(opt => {
            if (opt.selected) {
              badgeWrap.appendChild(makeBadge({ id: opt.value, name: opt.text, isNew: false }));
            }
          });
          newNames.forEach(name => badgeWrap.appendChild(makeBadge({ name, isNew: true })));
        }

        function syncNewField() {
          newField.value = Array.from(newNames).join(', ');
        }

        if (newField.value.trim()) {
          newField.value.split(',').forEach(n => {
            const name = n.trim();
            if (name) newNames.add(name);
          });
        }
        renderFromSelect();
        syncNewField();

        addInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const raw = addInput.value.trim();
            if (!raw) return;

            raw.split(',').forEach(piece => {
              const name = piece.trim();
              if (!name) return;

              const match = Array.from(selectEl.options)
                .find(opt => opt.text.toLowerCase() === name.toLowerCase());
              if (match) match.selected = true;
              else newNames.add(name);
            });

            addInput.value = '';
            renderFromSelect();
            syncNewField();
          }
        });

        badgeWrap.addEventListener('click', function (e) {
          const btn = e.target.closest('.category-badge__remove');
          if (!btn) return;
          const badge = btn.parentElement;
          const id = badge.dataset.catId;
          const name = badge.dataset.catName;
          const isNew = badge.dataset.new === '1';

          if (isNew) {
            newNames.delete(name);
          } else if (id) {
            const opt = Array.from(selectEl.options).find(o => o.value === String(id));
            if (opt) opt.selected = false;
          }
          renderFromSelect();
          syncNewField();
        });
      });
    </script>
  </main>
</div>
{% endblock %}
